# Model Downloader ServiceAccount and ConfigMap
#
# This creates the Kubernetes resources needed for S3-based model loading:
# - ServiceAccount with IRSA annotation for AWS S3 access
# - ConfigMap with the download script used by init containers
#
# Prerequisites:
#   1. Apply the Terraform in terraform/ to create the IAM role
#   2. Get the role ARN: terraform output model_downloader_role_arn
#   3. Update the annotation below with the actual role ARN
#
# Usage:
#   kubectl apply -f model-downloader-sa.yaml
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: model-downloader
  namespace: analysis
  annotations:
    # Replaced by Kustomize from config
    eks.amazonaws.com/role-arn: arn:aws:iam::$(AWS_ACCOUNT_ID):role/$(IAM_ROLE_NAME)
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: model-download-script
  namespace: analysis
data:
  download-stt.sh: |
    #!/bin/bash
    set -e

    DOWNLOAD_DIR="/models/.cache/huggingface/hub"
    MARKER_FILE="/models/.cache/.stt-download-complete"
    S3_BUCKET="s3://$(AWS_ACCOUNT_ID)-sagemaker-$(AWS_REGION)/$(S3_BUCKET_NAME)/audio-models/"

    mkdir -p "${DOWNLOAD_DIR}"

    # Check if already downloaded
    if [ -f "${MARKER_FILE}" ]; then
      echo "STT models already cached, skipping download"
      ls -lh "${DOWNLOAD_DIR}/" 2>/dev/null || true
      exit 0
    fi

    echo "Downloading STT models from S3..."
    echo "Source: ${S3_BUCKET}/stt/"
    echo "Destination: ${DOWNLOAD_DIR}/"

    # Download STT model files
    aws s3 sync "${S3_BUCKET}/stt/" "${DOWNLOAD_DIR}/models--kyutai--stt-1b-en_fr-candle/" \
      --no-progress \
      --only-show-errors

    # Verify download
    if [ -d "${DOWNLOAD_DIR}/models--kyutai--stt-1b-en_fr-candle" ]; then
      echo "STT model download complete"
      touch "${MARKER_FILE}"
      ls -lh "${DOWNLOAD_DIR}/models--kyutai--stt-1b-en_fr-candle/" 2>/dev/null || true
    else
      echo "ERROR: STT model download failed"
      exit 1
    fi

  download-tts.sh: |
    #!/bin/bash
    set -e

    DOWNLOAD_DIR="/models/.cache/huggingface/hub"
    MARKER_FILE="/models/.cache/.tts-download-complete"
    S3_BUCKET="s3://$(AWS_ACCOUNT_ID)-sagemaker-$(AWS_REGION)/$(S3_BUCKET_NAME)"

    mkdir -p "${DOWNLOAD_DIR}"

    # Check if already downloaded
    if [ -f "${MARKER_FILE}" ]; then
      echo "TTS models already cached, skipping download"
      ls -lh "${DOWNLOAD_DIR}/" 2>/dev/null || true
      exit 0
    fi

    echo "Downloading TTS models from S3..."
    echo "Source: ${S3_BUCKET}/tts/ and ${S3_BUCKET}/voices/"
    echo "Destination: ${DOWNLOAD_DIR}/"

    # Download TTS model files
    aws s3 sync "${S3_BUCKET}/tts/" "${DOWNLOAD_DIR}/models--kyutai--tts-1.6b-en_fr/" \
      --no-progress \
      --only-show-errors

    # Download TTS voice files
    aws s3 sync "${S3_BUCKET}/voices/" "${DOWNLOAD_DIR}/models--kyutai--tts-voices/" \
      --no-progress \
      --only-show-errors

    # Verify download
    if [ -d "${DOWNLOAD_DIR}/models--kyutai--tts-1.6b-en_fr" ]; then
      echo "TTS model download complete"
      touch "${MARKER_FILE}"
      ls -lh "${DOWNLOAD_DIR}/models--kyutai--tts-1.6b-en_fr/" 2>/dev/null || true
      ls -lh "${DOWNLOAD_DIR}/models--kyutai--tts-voices/" 2>/dev/null | head -5 || true
    else
      echo "ERROR: TTS model download failed"
      exit 1
    fi

  download-llm.sh: |
    #!/bin/bash
    set -e

    DOWNLOAD_DIR="/models/.cache/huggingface/hub"
    MARKER_FILE="/models/.cache/.llm-download-complete"
    S3_BUCKET="s3://$(AWS_ACCOUNT_ID)-sagemaker-$(AWS_REGION)/$(S3_BUCKET_NAME)"
    MODEL_DIR="models--$(echo $(MODEL_REPO) | tr '/' '-')"

    mkdir -p "${DOWNLOAD_DIR}"

    # Check if already downloaded
    if [ -f "${MARKER_FILE}" ]; then
      echo "LLM models already cached, skipping download"
      ls -lh "${DOWNLOAD_DIR}/" 2>/dev/null || true
      exit 0
    fi

    echo "Downloading LLM models from S3..."
    echo "Source: ${S3_BUCKET}/llm/"
    echo "Destination: ${DOWNLOAD_DIR}/"
    echo "Model: $(MODEL_NAME)"

    # Download LLM model files
    aws s3 sync "${S3_BUCKET}/llm/" "${DOWNLOAD_DIR}/${MODEL_DIR}/" \
      --no-progress \
      --only-show-errors

    # Verify download
    if [ -d "${DOWNLOAD_DIR}/${MODEL_DIR}" ]; then
      echo "LLM model download complete"
      touch "${MARKER_FILE}"
      ls -lh "${DOWNLOAD_DIR}/${MODEL_DIR}/" 2>/dev/null || true
    else
      echo "ERROR: LLM model download failed"
      exit 1
    fi
