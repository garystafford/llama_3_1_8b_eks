apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Namespace for all resources
namespace: analysis

# Common labels applied to all resources

# Resources to include
resources:
- namespace.yaml
- model-downloader-sa.yaml
- llm-deployment.yaml

# Generate ConfigMap from configuration file
configMapGenerator:
- envs:
  - config/default-config.env
  name: llm-config
  options:
    disableNameSuffixHash: true

# Replacements to inject config values into manifests
# Note: Kustomize will replace $(VAR_NAME) patterns in all resources
  # Replace AWS_REGION

  # Replace VLLM_IMAGE

  # Replace MODEL_REPO_DASHED in model path

  # Replace MODEL_REPO in served-model-name

  # Replace MODEL_MAX_LENGTH

  # Replace MODEL_GPU_MEMORY_UTIL

  # Replace LLM_MEMORY_LIMIT

  # Replace LLM_MEMORY_REQUEST

  # Replace LLM_CPU_LIMIT

  # Replace LLM_CPU_REQUEST

  # Replace EMPTYDIR_SIZE

  # Replace INSTANCE_TYPE

  # Replace AWS_ACCOUNT_ID and IAM_ROLE_NAME in ServiceAccount annotation

replacements:
- source:
    fieldPath: data.AWS_REGION
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.initContainers.[name=model-sync].env.[name=AWS_DEFAULT_REGION].value
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.VLLM_IMAGE
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].image
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_REPO_DASHED
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].args.0
    options:
      delimiter: models--
      index: 1
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_REPO
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].args.1
    options:
      delimiter: =
      index: 1
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_MAX_LENGTH
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].args.2
    options:
      delimiter: =
      index: 1
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_GPU_MEMORY_UTIL
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].args.4
    options:
      delimiter: =
      index: 1
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.LLM_MEMORY_LIMIT
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].resources.limits.memory
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.LLM_MEMORY_REQUEST
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].resources.requests.memory
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.LLM_CPU_LIMIT
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].resources.limits.cpu
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.LLM_CPU_REQUEST
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].resources.requests.cpu
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.EMPTYDIR_SIZE
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.volumes.[name=model-cache].emptyDir.sizeLimit
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.INSTANCE_TYPE
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.nodeSelector.[node.kubernetes.io/instance-type]
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.AWS_ACCOUNT_ID
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      delimiter: ':'
      index: 4
    select:
      kind: ServiceAccount
      name: model-downloader
- source:
    fieldPath: data.IAM_ROLE_NAME
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      delimiter: /
      index: 1
    select:
      kind: ServiceAccount
      name: model-downloader
labels:
- includeSelectors: true
  pairs:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/part-of: llm-deployment
