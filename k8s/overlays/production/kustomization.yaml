apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Reference base configuration
resources:
  - ../../base
  - llm-loadbalancer.yaml
  - llm-ingress.yaml

# Override namespace if needed
namespace: analysis

# Generate ConfigMap with production values
configMapGenerator:
  - name: llm-config
    envs:
      - config.env
    options:
      disableNameSuffixHash: true

# Replacements to inject config values into manifests
replacements:
- source:
    fieldPath: data.AWS_REGION
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.initContainers.[name=model-sync].env.[name=AWS_DEFAULT_REGION].value
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.VLLM_IMAGE
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].image
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_REPO_DASHED
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].args.0
    options:
      delimiter: models--
      index: 1
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_REPO
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].args.1
    options:
      delimiter: =
      index: 1
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_MAX_LENGTH
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].args.2
    options:
      delimiter: =
      index: 1
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_GPU_MEMORY_UTIL
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].args.4
    options:
      delimiter: =
      index: 1
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.LLM_MEMORY_LIMIT
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].resources.limits.memory
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.LLM_MEMORY_REQUEST
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].resources.requests.memory
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.LLM_CPU_LIMIT
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].resources.limits.cpu
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.LLM_CPU_REQUEST
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=llm].resources.requests.cpu
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.EMPTYDIR_SIZE
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.volumes.[name=model-cache].emptyDir.sizeLimit
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.AWS_ACCOUNT_ID
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      delimiter: ':'
      index: 4
    select:
      kind: ServiceAccount
      name: model-downloader
- source:
    fieldPath: data.IAM_ROLE_NAME
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      delimiter: /
      index: 1
    select:
      kind: ServiceAccount
      name: model-downloader

# Init container environment variables
- source:
    fieldPath: data.AWS_ACCOUNT_ID
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.initContainers.[name=model-sync].env.[name=AWS_ACCOUNT_ID].value
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.AWS_REGION
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.initContainers.[name=model-sync].env.[name=AWS_REGION].value
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.S3_BUCKET_NAME
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.initContainers.[name=model-sync].env.[name=S3_BUCKET_NAME].value
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_NAME
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.initContainers.[name=model-sync].env.[name=MODEL_NAME].value
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_REPO
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.initContainers.[name=model-sync].env.[name=MODEL_REPO].value
    select:
      kind: Deployment
      name: llm
- source:
    fieldPath: data.MODEL_REPO_DASHED
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.template.spec.initContainers.[name=model-sync].env.[name=MODEL_REPO_DASHED].value
    select:
      kind: Deployment
      name: llm

# LoadBalancer IP whitelist
- source:
    fieldPath: data.LOADBALANCER_IP_WHITELIST
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - spec.loadBalancerSourceRanges.0
    select:
      kind: Service
      name: llm-external

# Ingress configuration for HTTPS with ALB
- source:
    fieldPath: data.ACM_CERTIFICATE_ARN
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - metadata.annotations.[alb.ingress.kubernetes.io/certificate-arn]
    select:
      kind: Ingress
      name: llm-ingress
- source:
    fieldPath: data.DOMAIN_NAME
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - metadata.annotations.[external-dns.alpha.kubernetes.io/hostname]
    select:
      kind: Ingress
      name: llm-ingress
  - fieldPaths:
    - spec.rules.0.host
    select:
      kind: Ingress
      name: llm-ingress
- source:
    fieldPath: data.LOADBALANCER_IP_WHITELIST
    kind: ConfigMap
    name: llm-config
  targets:
  - fieldPaths:
    - metadata.annotations.[alb.ingress.kubernetes.io/inbound-cidrs]
    select:
      kind: Ingress
      name: llm-ingress

# Additional labels for all resources
labels:
- includeSelectors: true
  pairs:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/part-of: llm-deployment
    environment: production
